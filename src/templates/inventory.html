<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .summary-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        .summary-row:last-child {
            border-bottom: none;
            font-weight: bold;
            color: #198754;
        }
        .input-highlight {
            background-color: #fff3cd;
            border-color: #ffc107;
        }
        .auto-calculated {
            background-color: #d1ecf1;
            color: #0c5460;
            font-weight: 500;
        }
        .total-cell {
            font-weight: bold;
            color: #198754;
        }
        .table-responsive {
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .month-selector {
            max-width: 200px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">
                <i class="fas fa-warehouse me-2"></i>
                Inventario - {{ current_user.location }}
            </h2>
            
            <!-- Selettore mese -->
            <form method="GET" action="{{ url_for('inventory_bp.view_inventory') }}">
                <div class="input-group month-selector">
                    <select name="month" id="month" class="form-select" onchange="this.form.submit()">
                        {% for month in months %}
                            <option value="{{ month }}" {% if month == selected_month %}selected{% endif %}>
                                {{ month }}
                            </option>
                        {% endfor %}
                    </select>
                    <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                </div>
            </form>
        </div>

        <!-- Riepilogo Costi -->
        <div class="summary-card p-4 mb-4">
            <h5 class="mb-3">
                <i class="fas fa-chart-line me-2"></i>
                Riepilogo Costi
            </h5>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="summary-row">
                        <span><i class="fas fa-history me-2"></i>Inventario Iniziale:</span>
                        <strong class="auto-calculated">${{ "%.2f"|format(inventory_meta.previous_inventory or 0) }}</strong>
                    </div>
                    <div class="summary-row">
                        <span><i class="fas fa-truck me-2"></i>Acquisti (Ordini):</span>
                        <strong class="auto-calculated">${{ "%.2f"|format(inventory_meta.vendor_spending or 0) }}</strong>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="summary-row">
                        <span><i class="fas fa-receipt me-2"></i>Note di Credito:</span>
                        <strong>${{ "%.2f"|format(inventory_meta.credit_notes or 0) }}</strong>
                    </div>
                    <div class="summary-row">
                        <span><i class="fas fa-dollar-sign me-2"></i>Vendite:</span>
                        <strong>${{ "%.2f"|format(inventory_meta.monthly_sales or 0) }}</strong>
                    </div>
                </div>
            </div>
            
            <div class="summary-row mt-3">
                <span><i class="fas fa-percentage me-2"></i>Food Cost:</span>
                <strong>{{ inventory_meta.food_cost() }}%</strong>
            </div>
        </div>

        <!-- Form principale -->
        <form method="POST" action="{{ url_for('inventory_bp.update_inventory') }}" id="inventoryForm">
            <input type="hidden" name="month" value="{{ selected_month }}">

            <!-- Campi modificabili manualmente -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="credit_notes" class="form-label">
                            <i class="fas fa-receipt me-1"></i> Note di Credito ($)
                        </label>
                        <input type="number" step="0.01" min="0" class="form-control input-highlight" 
                               id="credit_notes" name="credit_notes" 
                               value="{{ inventory_meta.credit_notes or 0 }}"
                               onchange="calculateFoodCost()">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="monthly_sales" class="form-label">
                            <i class="fas fa-dollar-sign me-1"></i> Vendite del Mese ($)
                        </label>
                        <input type="number" step="0.01" min="0" class="form-control input-highlight" 
                               id="monthly_sales" name="monthly_sales" 
                               value="{{ inventory_meta.monthly_sales or 0 }}"
                               onchange="calculateFoodCost()">
                    </div>
                </div>
            </div>

            <!-- Tabella inventario -->
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th><i class="fas fa-box me-1"></i> Prodotto</th>
                            <th><i class="fas fa-ruler me-1"></i> Unità</th>
                            <th><i class="fas fa-sort-numeric-up me-1"></i> Quantità</th>
                            <th><i class="fas fa-tag me-1"></i> Prezzo Unitario</th>
                            <th><i class="fas fa-calculator me-1"></i> Totale</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product, item in inventory_items %}
                        <tr>
                            <td>
                                <strong>{{ item.product_name }}</strong>
                                <br><small class="text-muted">{{ item.supplier_name }}</small>
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ product.unit }}</span>
                            </td>
                            <td>
                                <input type="number" step="0.01" min="0" 
                                       class="form-control" 
                                       name="qty_{{ item.product_name }}" 
                                       value="{{ item.quantity }}"
                                       onchange="updateRowTotal(this)"
                                       style="max-width: 120px;">
                            </td>
                            <td>
                                <div class="input-group" style="max-width: 150px;">
                                    <span class="input-group-text">$</span>
                                    <input type="number" step="0.01" min="0" 
                                           class="form-control" 
                                           name="price_{{ item.product_name }}" 
                                           value="{{ item.unit_price }}"
                                           onchange="updateRowTotal(this)">
                                </div>
                            </td>
                            <td class="total-cell" id="total_{{ loop.index }}">
                                ${{ "%.2f"|format(item.total() or 0) }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <th colspan="4" class="text-end">Totale Inventario:</th>
                            <th class="total-cell" id="grandTotal">
                                ${{ "%.2f"|format(inventory_items|sum(attribute='1.total')|default(0, true)) }}
                            </th>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Pulsanti azione -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-save me-2"></i>Salva Modifiche
                    </button>
                </div>
                <div class="col-md-6 text-end">
                    <div class="btn-group" role="group">
                        <a href="{{ url_for('inventory_bp.export_inventory_pdf', month=selected_month) }}" 
                           class="btn btn-danger">
                            <i class="fas fa-file-pdf me-1"></i> PDF
                        </a>
                        <a href="{{ url_for('inventory_bp.export_inventory_csv', month=selected_month) }}" 
                           class="btn btn-primary">
                            <i class="fas fa-file-csv me-1"></i> CSV
                        </a>
                    </div>
                </div>
            </div>
        </form>

        <!-- Admin controls (se necessario) -->
        {% if current_user.is_admin %}
        <div class="mt-4 p-3 bg-light rounded">
            <h6>Controlli Admin</h6>
            <div class="row">
                <div class="col-md-6">
                    <form method="GET" action="{{ url_for('inventory_bp.export_inventory_csv') }}" class="d-flex gap-2">
                        <input type="hidden" name="month" value="{{ selected_month }}">
                        <select name="location" class="form-select" required>
                            <option value="">Seleziona location</option>
                            {% for loc in locations %}
                                <option value="{{ loc }}">{{ loc }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-outline-primary">CSV per Location</button>
                    </form>
                </div>
                <div class="col-md-6">
                    <form method="GET" action="{{ url_for('inventory_bp.export_inventory_pdf') }}" class="d-flex gap-2">
                        <input type="hidden" name="month" value="{{ selected_month }}">
                        <select name="location" class="form-select" required>
                            <option value="">Seleziona location</option>
                            {% for loc in locations %}
                                <option value="{{ loc }}">{{ loc }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-outline-danger">PDF per Location</button>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function updateRowTotal(input) {
            const row = input.closest('tr');
            const qtyInput = row.querySelector('input[name^="qty_"]');
            const priceInput = row.querySelector('input[name^="price_"]');
            const totalCell = row.querySelector('.total-cell');
            
            const qty = parseFloat(qtyInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const total = qty * price;
            
            totalCell.textContent = '$' + total.toFixed(2);
            
            // Aggiorna il totale generale
            updateGrandTotal();
        }
        
        function updateGrandTotal() {
            let grandTotal = 0;
            document.querySelectorAll('tbody .total-cell').forEach(cell => {
                const value = parseFloat(cell.textContent.replace('$', '')) || 0;
                grandTotal += value;
            });
            document.getElementById('grandTotal').textContent = '$' + grandTotal.toFixed(2);
        }
        
        function calculateFoodCost() {
            const vendorSpending = {{ inventory_meta.vendor_spending or 0 }};
            const creditNotes = parseFloat(document.getElementById('credit_notes').value) || 0;
            const monthlySales = parseFloat(document.getElementById('monthly_sales').value) || 0;
            
            if (monthlySales > 0) {
                const foodCost = ((vendorSpending - creditNotes) / monthlySales) * 100;
                // Aggiorna il display del food cost in tempo reale se necessario
                console.log('Food Cost calcolato:', foodCost.toFixed(2) + '%');
            }
        }
        
        // Inizializza i calcoli al caricamento della pagina
        document.addEventListener('DOMContentLoaded', function() {
            updateGrandTotal();
        });
    </script>
</body>
</html>